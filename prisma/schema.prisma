generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id              String            @id @default(cuid())
  name            String            @unique
  code            String?
  logoPath        String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  admins          Admin[]
  deliveryNotes   DeliveryNote[]
  returnNotes     ReturnNote[]
  machines        Machine[]
  screens         Screen[]
  softwareCatalog SoftwareCatalog[]
  users           User[]
}

model User {
  id                    String                 @id @default(cuid())
  firstName             String
  lastName              String
  email                 String                 @unique
  companyId             String
  office365Subscription String?
  globalEmail           String?
  emailLogin            String?
  phone                 String?
  googleAuthId          String?                @unique
  role                  String                 @default("viewer")
  department            String?
  office                String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  admin                 Admin?
  deliveryNotesCreated  DeliveryNote[]
  returnNotesCreated    ReturnNote[]           @relation("ReturnNotesCreated")
  installationSheets    InstallationSheet[]
  machines              Machine[]
  screens               Screen[]
  softwareInstallations SoftwareInstallation[]
  company               Company                @relation(fields: [companyId], references: [id])
  userEmails            UserEmail[]

  @@index([companyId])
  @@index([email])
}

model UserEmail {
  id        String   @id @default(cuid())
  email     String
  userId    String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([userId])
}

model Machine {
  id                String                 @id @default(cuid())
  inventoryCode     String                 @unique
  serialNumber      String                 @unique
  machineName       String
  type              String
  vendor            String
  model             String
  acquisitionDate   DateTime
  windowsVersion    String?
  productKey        String?
  cpu               String?
  ram               String?
  disk              String?
  inventoryTicket   Boolean                @default(false)
  warrantyDate      DateTime?
  assetStatus       String                 @default("en_stock")
  companyId         String
  userId            String?
  deliveryNoteId    String?
  qrCodePath        String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  installationSheet InstallationSheet?
  company           Company                @relation(fields: [companyId], references: [id])
  deliveryNote      DeliveryNote?          @relation(fields: [deliveryNoteId], references: [id])
  user              User?                  @relation(fields: [userId], references: [id])
  screens           Screen[]
  installations     SoftwareInstallation[]

  @@index([companyId])
  @@index([userId])
  @@index([inventoryCode])
  @@index([serialNumber])
}

model Screen {
  id            String    @id @default(cuid())
  brand         String
  serialNumber  String    @unique
  inventoryCode String    @unique
  model         String?
  size          String?
  resolution    String?
  purchaseDate  DateTime?
  warrantyDate  DateTime?
  assetStatus   String    @default("en_stock")
  machineId     String?
  userId        String?
  companyId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  machine       Machine?  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user          User?     @relation(fields: [userId], references: [id])
  company       Company   @relation(fields: [companyId], references: [id])

  @@index([machineId])
  @@index([userId])
  @@index([companyId])
}

model DeliveryNote {
  id               String                   @id @default(cuid())
  noteNumber       String                   @unique
  vendor           String?
  deliveryDate     DateTime
  purchaseOrderRef String?
  status           String                   @default("pending")
  receivedBy       String?
  notes            String?
  pdfPath          String?
  companyId        String
  createdById      String
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  deliveryItems    DeliveryItem[]
  equipments       DeliveryNoteEquipment[]
  company          Company                  @relation(fields: [companyId], references: [id])
  createdBy        User                     @relation(fields: [createdById], references: [id])
  machines         Machine[]

  @@index([companyId])
  @@index([noteNumber])
}

model DeliveryNoteEquipment {
  id             String       @id @default(cuid())
  deliveryNoteId String
  type           String
  serialNumber   String
  brand          String?
  model          String?
  inventoryCode  String?
  createdAt      DateTime     @default(now())
  deliveryNote   DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)

  @@index([deliveryNoteId])
  @@index([serialNumber])
}

model DeliveryItem {
  id             String       @id @default(cuid())
  description    String
  quantity       Int
  unitPrice      Float?
  expectedSerial String?
  receivedSerial String?
  status         String       @default("expected")
  deliveryNoteId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deliveryNote   DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)

  @@index([deliveryNoteId])
}

model InstallationSheet {
  id                     String   @id @default(cuid())
  installationDate       DateTime
  technicianId           String
  networkConfig          Json
  softwareInstalled      Json
  customApplications     Json?
  preDeploymentChecklist Json
  digitalSignaturePath   String?
  notes                  String?
  machineId              String   @unique
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  machine                Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  technician             User     @relation(fields: [technicianId], references: [id])

  @@index([technicianId])
}

model SoftwareCatalog {
  id             String                 @id @default(cuid())
  name           String
  version        String
  vendor         String
  licenseType    String
  licenseKey     String?
  seatsAvailable Int
  seatsUsed      Int                    @default(0)
  expirationDate DateTime?
  purchaseDate   DateTime?
  purchasePrice  Float?
  companyId      String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  company        Company                @relation(fields: [companyId], references: [id])
  installations  SoftwareInstallation[]

  @@unique([companyId, name, version])
  @@index([companyId])
}

model SoftwareInstallation {
  id               String          @id @default(cuid())
  installationDate DateTime        @default(now())
  installedById    String
  licenseUsed      String?
  softwareId       String
  machineId        String
  status           String          @default("active")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  installedBy      User            @relation(fields: [installedById], references: [id])
  machine          Machine         @relation(fields: [machineId], references: [id], onDelete: Cascade)
  software         SoftwareCatalog @relation(fields: [softwareId], references: [id])

  @@index([softwareId])
  @@index([machineId])
  @@index([installedById])
}

model Admin {
  id        String   @id @default(cuid())
  role      String
  userId    String   @unique
  companyId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company? @relation(fields: [companyId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model InventorySequence {
  id          String   @id @default(cuid())
  companyCode String
  assetType   String
  lastNumber  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyCode, assetType])
}

model DeliveryNoteSequence {
  id         String   @id @default(cuid())
  year       Int      @unique
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ReturnNote {
  id             String              @id @default(cuid())
  noteNumber     String              @unique
  returnDate     DateTime
  returnedBy     String
  reason         String?
  destination    String              @default("stock") // "stock" ou "reparation" ou "rebut"
  notes          String?
  pdfPath        String?
  companyId      String
  createdById    String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  equipments     ReturnNoteEquipment[]
  company        Company             @relation(fields: [companyId], references: [id])
  createdBy      User                @relation("ReturnNotesCreated", fields: [createdById], references: [id])

  @@index([companyId])
  @@index([noteNumber])
}

model ReturnNoteEquipment {
  id             String     @id @default(cuid())
  returnNoteId   String
  type           String     // "machine" | "screen" | "peripheral"
  serialNumber   String
  brand          String?
  model          String?
  inventoryCode  String?
  previousUser   String?    // Nom de l'utilisateur qui retourne l'Ã©quipement
  condition      String?    // "bon" | "moyen" | "mauvais"
  createdAt      DateTime   @default(now())
  returnNote     ReturnNote @relation(fields: [returnNoteId], references: [id], onDelete: Cascade)

  @@index([returnNoteId])
  @@index([serialNumber])
}

model ReturnNoteSequence {
  id         String   @id @default(cuid())
  year       Int      @unique
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model OperatingSystem {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model ConsumableType {
  id        String       @id @default(cuid())
  name      String
  code      String?      @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  consumables Consumable[]

  @@unique([name])
}

model Consumable {
  id           String    @id @default(cuid())
  typeId       String
  companyId    String
  quantity     Int       @default(0)
  minimumStock Int?      // optional threshold
  note         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  type    ConsumableType @relation(fields: [typeId], references: [id])
  company Company        @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([typeId])
  @@unique([companyId, typeId])
}
